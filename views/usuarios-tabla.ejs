
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<section>
   <style>
    .table-responsive{
        overflow: hidden;
    }
    @media (max-width: 767px) {
  .table-responsive {
    overflow: auto;
  }
       }
   </style>

   <div class="table-responsive ">
    <table class="table">
        <thead class="thead-dark">
            <tr>
                <th class="text-uppercase">Cargo</th>
                <th class="text-uppercase">Usuario</th>
                <th class="text-uppercase">Nombre</th>
                <th class="text-uppercase">Carnet</th>
                <th class="text-uppercase" id="layoutInSection">Modificar</th>
            </tr>
        </thead>
        <tbody>
            <% if (usuarios && usuarios.length) { %>
                <% usuarios.forEach((usuario) => { %>
                    <tr>
                        <td class="text"><%= usuario.rol %></td>
                        <td class="text"><%= usuario.username %></td>
                        <td class="text"><%= usuario.nombres %>&nbsp; <%= usuario.apellidos %></td>
                        <td class="text"><%= usuario.ci %></td>
                        <td class="text" style="display: none;"><%= usuario.id %></td>
                        <td>
                          <div class="d-flex justify-content-center justify-content-sm-start">
                            <button type="button" id="layoutInSection" class="btn btn-primary btn-sm btn-icon btn-editar-usuario" data-toggle="modal" data-target="#registrationModal" data-id="<%= usuario.id %>">
                              <i class="fas fa-edit"></i>
                            </button>
                            </button>&nbsp;
                            <button type="button" id="layoutInSection" class="btn btn-danger btn-sm btn-icon" onclick="confirmarBorrado('<%= usuario.id %>')">
                              <i class="fas fa-trash-alt"></i>
                            </button>
                            </div>
                        </td>
                    </tr>
                <% }) %>
            <% } else { %>
                <tr>
                    <td colspan="5" class="text-center">No se encontraron usuarios.</td>
                </tr>
            <% } %>
        </tbody>
        <tfoot>
            <tr>
                
            </tr>
        </tfoot>
    </table>
</div>
</section>

<!-- Modal -->
<div class="modal fade" id="registrationModal" tabindex="-1" role="dialog" aria-labelledby="registrationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content" >
      <div class="modal-header" style="background-color: white; color: black;">
        <center>
          <h5 class="modal-title-centered text" id="registrationModalLabel" style="color: black;">Editar Usuario</h5>
        </center>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="">
        <form style="padding-left: 50px;">
          <center>
            <div class="form-row">
              
              <input type="hidden" id="userId" name="userId">

              <div class="form-group col-md-5">
                <label for="rol">Rol:</label>
                <select class="form-control" id="rol" required style="width: 300px; height: 35px;" >
                  <option value="" style="color: black;">Seleccione un rol</option>
                  <option value="Abogado" style="color: black;">Abogado</option>
                  <option value="Secretaria" style="color: black;">Secretaria</option>
                </select>
              </div>
              
          </center>
        </form>
      </div>
      <div class="modal-footer" style="background-color: white;">
        <button type="button" class="btn btn-primary" onclick="guardarUsuario()">Guardar</button>
        <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

  
<script>
     function confirmarBorrado(userId) {
  Swal.fire({
    title: 'Confirmación',
    text: '¿Estás seguro de que deseas dar de baja a este usuario?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Confirmar',
    confirmButtonColor: 'Blue',
    cancelButtonText: 'Cancelar',
    cancelButtonColor: 'Red',
    dangerMode: true
  }).then((result) => {
    if (result.isConfirmed) {
      // Realiza una solicitud PUT al servidor para cambiar el estado del usuario
      $.ajax({
        url: `/borrar/${userId}`,
        type: 'PUT',
        data: { estado: false }, // Cambia el estado del usuario a false
        success: function(response) {
          // Si la eliminación fue exitosa, muestra un mensaje de éxito
          Swal.fire({
            title: 'Éxito',
            text: response.message,
            icon: 'success',
            confirmButtonText: 'Aceptar',
            confirmButtonColor: 'Blue'
          }).then(() => {
            // Actualiza la página o realiza cualquier otra acción necesaria
            location.reload();
          });
        },
        error: function(error) {
          // Si ocurrió un error durante la eliminación, muestra un mensaje de error
          console.log(error);
          Swal.fire({
            title: 'Error',
            text: 'Ocurrió un error al dar de baja el usuario',
            icon: 'error',
            confirmButtonText: 'Aceptar',
            confirmButtonText: 'Blue'
          });
        },
      });
    }
  });
}

   
</script>

<script>
  $(document).ready(function() {
    // Escucha el evento click en el botón de edición
    $(document).on('click', '.btn-editar-usuario', function(event) {
      const button = $(event.currentTarget); // Botón que activó el modal
      const userId = button.data('id'); // ID del usuario
  
      // Hace una solicitud GET al servidor para obtener los datos del usuario
      $.get(`/usuarios/${userId}`, function(data) {
        console.log("Estos son los datos que llegaron:", data);
        // Rellena los campos del formulario en el modal con los datos recibidos
        $('#nombres').val(data.nombres);
        $('#apellidos').val(data.apellidos);
        $('#username').val(data.username);
        $('#ci').val(data.ci);
        $('#direccion').val(data.direccion);
        $('#rol').val(data.rol);
        $('#fechaNacimiento').val(data.fechanac);
        $('#phone').val(data.phone);
        $('#userId').val(userId); // Asegúrate de que estás asignando el ID del usuario al input correcto
      });
    });
  });
  
  // Obtén la referencia al elemento <select>
  var selectRol = document.getElementById('rol');
  
  // Establece la opción seleccionada según el valor de la variable 'rol'
  selectRol.value = rol;
  
  function guardarUsuario() {
  const userId = $('#userId').val();
  const rol = $('#rol').val();

  // Objeto con el campo 'rol' actualizado
  var data = {
    rol: rol,
  };

  // Realiza una solicitud POST al servidor para actualizar el usuario
  console.log('/editusuarios/${userId}');
  fetch('/editusuarios/${userId}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data),
  })
    .then((response) => response.json())
    .then((result) => {
      // Si la actualización fue exitosa, muestra un mensaje y cierra el modal
      Swal.fire({
        title: 'Éxito',
        text: result.message,
        icon: 'success',
        confirmButtonText: 'Aceptar',
      }).then(() => {
        $('#registrationModal').modal('hide');
        location.reload(); // Actualiza la página después de cerrar el modal
      });
    })
    .catch((error) => {
      Swal.fire({
        title: 'Error',
        text: 'Ocurrió un error al actualizar el usuario',
        icon: 'error',
        confirmButtonText: 'Aceptar',
      });
    });
}


  </script>
  
  


 <!-- Incluye la biblioteca de FontAwesome -->
 <script src="https://kit.fontawesome.com/xxxxxxxxxx.js" crossorigin="anonymous"></script>
 <!-- Incluye la biblioteca de jQuery -->
 
 <!-- Incluye la biblioteca de SweetAlert -->
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>
 <!-- Incluye la biblioteca de Bootstrap -->
 <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
