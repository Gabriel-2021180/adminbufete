
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.css">
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<section>
   <style>
    .table-responsive{
        overflow: hidden;
    }
    @media (max-width: 767px) {
  .table-responsive {
    overflow: auto;
  }
       }
   </style>

   <div class="table-responsive ">
    <table class="table">
        <thead class="thead-dark">
            <tr>
                <th class="text-uppercase">Rol</th>
                <th class="text-uppercase">Usuario</th>
                <th class="text-uppercase">Nombre</th>
                <th class="text-uppercase">Carnet</th>
                <th class="text-uppercase">Modificar</th>
            </tr>
        </thead>
        <tbody>
            <% if (usuarios && usuarios.length) { %>
                <% usuarios.forEach((usuario) => { %>
                    <tr>
                        <td class="text"><%= usuario.rol %></td>
                        <td class="text"><%= usuario.username %></td>
                        <td class="text"><%= usuario.nombres %>&nbsp; <%= usuario.apellidos %></td>
                        <td class="text"><%= usuario.ci %></td>
                        <td class="text" style="display: none;"><%= usuario.id %></td>
                        <td>
                          <div class="d-flex justify-content-center justify-content-sm-start">
                            <button type="button" class="btn btn-primary btn-sm btn-icon btn-editar-usuario" data-toggle="modal" data-target="#registrationModal" data-id="<%= usuario.id %>">
                              <i class="fas fa-edit"></i>
                            </button>
                            </button>&nbsp;
                            <button type="button" class="btn btn-danger btn-sm btn-icon" onclick="confirmarBorrado('<%= usuario.id %>')">
                              <i class="fas fa-trash-alt"></i>
                            </button>
                            </div>
                        </td>
                    </tr>
                <% }) %>
            <% } else { %>
                <tr>
                    <td colspan="5" class="text-center">No se encontraron usuarios.</td>
                </tr>
            <% } %>
        </tbody>
        <tfoot>
            <tr>
                
            </tr>
        </tfoot>
    </table>
</div>
</section>

<!-- Modal -->
<div class="modal fade" id="registrationModal" tabindex="-1" role="dialog" aria-labelledby="registrationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
        <div class="modal-header">
          <center><h5 class="modal-title-centered text-white" id="registrationModalLabel">Editar Usuario</h5></center>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="">
          <form style="padding-left: 50px;">
            <center>
            <div class="form-row">
              <div class="form-group col-md-5">
                <label for="nombres">Nombres:</label>
                <input type="text" maxlength="50" class="form-control" id="nombres" placeholder="Ingrese el o los nombres" required>
              </div>
              <div class="form-group col-md-5">
                <label for="apellidos">Apellidos:</label>
                <input type="text" maxlength="50" class="form-control" id="apellidos" placeholder="Ingrese el o los apellidos" required>
              </div>
              <div class="form-group col-md-5">
                <label for="username">Username:</label>
                <input type="text" maxlength="32" class="form-control" id="username" placeholder="Ingrese el nombre de usuario" required>
              </div>
              <div class="form-group col-md-5">
                <label for="ci">CI:</label>
                <input type="text" maxlength="10" class="form-control" id="ci" placeholder="Ingrese el Nº de documento" required>
              </div>
              <div class="form-group col-md-5">
                <label for="direccion">Dirección:</label>
                <input type="text" maxlength="50" class="form-control" id="direccion" placeholder="Ingrese la dirección del usuario" required>
              </div>
              <input type="hidden" id="userId" name="userId">
              <div class="form-group col-md-5">
                <label for="rol">Rol:</label>
                <select class="form-control" id="rol" required>
                  <option value="" style="color: black;">Seleccione un rol</option>
                  <option value="Abogado" style="color: black;">Abogado</option>
                  <option value="Secretaria" style="color: black;">Secretaria</option>
                </select>
              </div>
              <div class="form-group col-md-5">
                <label for="fechanac">Fecha de Nacimiento:</label>
                <input type="date" class="form-control" id="fechaNacimiento" required>
              </div>
              <div class="form-group col-md-5">
                <label for="phone">Teléfono:</label>
                <input type="text" class="form-control" maxlength="10" id="phone" placeholder="Ingrese el número de teléfono del usuario" required>
              </div>
              
            </div>
          </center>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="guardarUsuario()">Guardar</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  
<script>
     function confirmarBorrado(userId) {
  Swal.fire({
    title: 'Confirmación',
    text: '¿Estás seguro de que deseas dar de baja a este usuario?',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Confirmar',
    cancelButtonText: 'Cancelar',
    dangerMode: true
  }).then((result) => {
    if (result.isConfirmed) {
      // Realiza una solicitud PUT al servidor para cambiar el estado del usuario
      $.ajax({
        url: `/borrar/${userId}`,
        type: 'PUT',
        data: { estado: false }, // Cambia el estado del usuario a false
        success: function(response) {
          // Si la eliminación fue exitosa, muestra un mensaje de éxito
          Swal.fire({
            title: 'Éxito',
            text: response.message,
            icon: 'success',
            confirmButtonText: 'Aceptar',
          }).then(() => {
            // Actualiza la página o realiza cualquier otra acción necesaria
            location.reload();
          });
        },
        error: function(error) {
          // Si ocurrió un error durante la eliminación, muestra un mensaje de error
          console.log(error);
          Swal.fire({
            title: 'Error',
            text: 'Ocurrió un error al eliminar el usuario',
            icon: 'error',
            confirmButtonText: 'Aceptar',
          });
        },
      });
    }
  });
}

   
</script>

<script>
 $(document).ready(function() {
  // Escucha el evento click en el botón de edición
  $(document).on('click', '.btn-editar-usuario', function(event) {
    const button = $(event.currentTarget); // Botón que activó el modal
    const userId = button.data('id'); // ID del usuario

    // Hace una solicitud GET al servidor para obtener los datos del usuario
    $.get(`/usuarios/${userId}`, function(data) {
      console.log("Estos son los datos que llegaron:", data);
      // Rellena los campos del formulario en el modal con los datos recibidos
      $('#nombres').val(data.nombres);
      $('#apellidos').val(data.apellidos);
      $('#username').val(data.username);
      $('#ci').val(data.ci);
      $('#direccion').val(data.direccion);
      $('#rol').val(data.rol);
      $('#fechaNacimiento').val(data.fechanac);
      $('#phone').val(data.phone);
      $('#userId').val(userId); // Asegúrate de que estás asignando el ID del usuario al input correcto
    });
  });
});

// Obtén la referencia al elemento <select>
  var selectRol = document.getElementById('rol');

// Establece la opción seleccionada según el valor de la variable 'rol'
selectRol.value = rol;
function guardarUsuario() {
  const userId = $('#userId').val();
  const nombres = $('#nombres').val();
  const apellidos = $('#apellidos').val();
  const username = $('#username').val();
  const ci = $('#ci').val();
  const direccion = $('#direccion').val();
  const rol = $('#rol').val();
  const fechanac = $('#fechaNacimiento').val();
  const phone = $('#phone').val();
  const email = $('#email').val();
  const password = $('#password').val();

  // Objeto con los datos actualizados del usuario
  var data = {
    nombres: nombres,
    apellidos: apellidos,
    username: username,
    ci: ci,
    direccion: direccion,
    rol: rol,
    fechanac: fechanac,
    phone: phone,
    email: email,
    password: password,
  };

  // Realiza una solicitud PUT al servidor para actualizar el usuario
  $.ajax({
    url: `/editusuarios/${userId}`,
    type: 'PUT',
    data: data,
    success: function(response) {
      // Si la actualización fue exitosa, muestra un mensaje y cierra el modal
      Swal.fire({
        title: 'Éxito',
        text: response.message,
        icon: 'success',
        confirmButtonText: 'Aceptar',
      }).then(() => {
        $('#registrationModal').modal('hide');
      });
    },
    error: function(error) {
      
      console.log(error)
      Swal.fire({
        title: 'Error',
        text: 'Ocurrió un error al actualizar el usuario',
        icon: 'error',
        confirmButtonText: 'Aceptar',
      });
      
    },
  });
}


</script>

 <!-- Incluye la biblioteca de FontAwesome -->
 <script src="https://kit.fontawesome.com/xxxxxxxxxx.js" crossorigin="anonymous"></script>
 <!-- Incluye la biblioteca de jQuery -->
 
 <!-- Incluye la biblioteca de SweetAlert -->
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>
 <!-- Incluye la biblioteca de Bootstrap -->
 <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
